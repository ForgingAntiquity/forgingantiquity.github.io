---
layout: wide
title: Public Database
---

<style>
  .controls {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    margin-bottom: 16px;
    align-items: center;
  }
  .controls input[type="text"] {
    padding: 8px 12px;
    border: 1px solid #ccc;
    border-radius: 6px;
    font-size: 0.95rem;
    flex: 1;
    min-width: 200px;
  }
  .controls button {
    padding: 8px 16px;
    border: none;
    border-radius: 6px;
    background: #3498db;
    color: white;
    font-size: 0.95rem;
    cursor: pointer;
  }
  .controls button:hover { background: #2980b9; }
  #status { margin-bottom: 8px; font-size: 0.9rem; color: #888; }
  #row-count { font-size: 0.9rem; color: #666; margin-bottom: 10px; }

  .table-wrapper {
    overflow-x: auto;
    overflow-y: auto;
    height: 600px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }
  table {
    width: 100%;
    border-collapse: collapse;
    background: white;
    font-size: 0.92rem;
  }
  thead tr {
    background: #2c3e50;
    color: white;
  }
  thead th {
    position: sticky;
    top: 0;
    z-index: 2;
    padding: 12px 14px;
    text-align: left;
    cursor: pointer;
    user-select: none;
    white-space: nowrap;
    background: #2c3e50;
  }
  thead th:hover { background: #34495e; }
  thead th .sort-icon { margin-left: 6px; font-size: 0.8rem; opacity: 0.6; }
  thead th.sort-asc .sort-icon::after { content: "â–²"; }
  thead th.sort-desc .sort-icon::after { content: "â–¼"; }
  thead th:not(.sort-asc):not(.sort-desc) .sort-icon::after { content: "â‡…"; }

  thead tr.filter-row th {
    position: sticky;
    top: 45px;
    z-index: 2;
    background: #ecf0f1;
    padding: 6px 8px;
    cursor: default;
  }
  thead tr.filter-row th input,
  thead tr.filter-row th select {
    width: 100%;
    padding: 5px 8px;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: 0.85rem;
    background: white;
  }

  tbody tr:nth-child(even) { background: #f8f9fa; }
  tbody tr:hover { background: #eaf4fb; }
  tbody td {
    padding: 10px 14px;
    border-bottom: 1px solid #e0e0e0;
    vertical-align: top;
    max-width: 180px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  tbody td.tm-col { max-width: 120px; }

  /* Tooltip on hover */
  tbody td[title]:hover {
    position: relative;
    overflow: visible;
    white-space: normal;
    background: #fffbe6;
    z-index: 10;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    border-radius: 4px;
  }

  .no-data { text-align: center; padding: 30px; color: #888; font-style: italic; }

  a.tm-link { color: #2980b9; text-decoration: none; }
  a.tm-link:hover { text-decoration: underline; }
</style>

<div class="controls">
  <input type="text" id="global-search" placeholder="ðŸ” Search all columns..." oninput="applyFilters()" />
  <button onclick="clearAllFilters()">Clear Filters</button>
  <button onclick="exportCSV()">Export CSV</button>
</div>

<div id="status">Loading data...</div>
<div id="row-count"></div>

<div class="table-wrapper">
  <table id="data-table">
    <thead>
      <tr id="header-row"></tr>
      <tr class="filter-row" id="filter-row"></tr>
    </thead>
    <tbody id="table-body"></tbody>
  </table>
</div>

<script>
  const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRtyGEmEVnftuJGoHfJM-VaWdDE65gXUgG1dsWWzT9MzXJggi_qDz7i46H4R9LWWA/pub?gid=1027676349&single=true&output=csv";

  // Columns that get dropdown filters (matched by header name)
  const DROPDOWN_COLS = ["Material", "Format", "Aspirational Format", "Script", "Typology"];

  // Index of the T.M. Number column (detected automatically by name)
  let tmColIndex = -1;

  let allRows = [], headers = [], filteredRows = [], sortCol = -1, sortDir = 1;

  async function loadSheet() {
    try {
      const res = await fetch(CSV_URL);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const text = await res.text();
      parseCSV(text);
      document.getElementById("status").textContent = "Data loaded successfully.";
    } catch (e) {
      document.getElementById("status").textContent = `Error loading sheet: ${e.message}.`;
    }
  }

  function parseCSV(text) {
    const rows = [];
    let row = [], cell = "", inQuote = false;
    for (let i = 0; i < text.length; i++) {
      const ch = text[i], next = text[i + 1];
      if (inQuote) {
        if (ch === '"' && next === '"') { cell += '"'; i++; }
        else if (ch === '"') inQuote = false;
        else cell += ch;
      } else {
        if (ch === '"') inQuote = true;
        else if (ch === ',') { row.push(cell.trim()); cell = ""; }
        else if (ch === '\n' || (ch === '\r' && next === '\n')) {
          if (ch === '\r') i++;
          row.push(cell.trim()); rows.push(row); row = []; cell = "";
        } else cell += ch;
      }
    }
    if (cell || row.length) { row.push(cell.trim()); rows.push(row); }
    if (rows.length === 0) return;
    headers = rows[0];
    tmColIndex = headers.findIndex(h => h.trim().toLowerCase() === "t.m. number");
    allRows = rows.slice(1).filter(r => r.some(c => c !== ""));
    buildHeaders();
    applyFilters();
  }

  function buildHeaders() {
    const headerRow = document.getElementById("header-row");
    const filterRow = document.getElementById("filter-row");
    headerRow.innerHTML = "";
    filterRow.innerHTML = "";

    headers.forEach((h, i) => {
      // Sort header
      const th = document.createElement("th");
      th.innerHTML = `${h} <span class="sort-icon"></span>`;
      th.dataset.col = i;
      th.addEventListener("click", () => sortByCol(i, th));
      headerRow.appendChild(th);

      // Filter cell
      const ftd = document.createElement("th");
      if (DROPDOWN_COLS.includes(h.trim())) {
        const sel = document.createElement("select");
        sel.dataset.col = i;
        // Collect unique values for this column
        const values = [...new Set(allRows.map(r => (r[i] || "").trim()))]
          .filter(v => v !== "")
          .sort();
        const blank = document.createElement("option");
        blank.value = "";
        blank.textContent = `All ${h}`;
        sel.appendChild(blank);
        values.forEach(v => {
          const opt = document.createElement("option");
          opt.value = v;
          opt.textContent = v;
          sel.appendChild(opt);
        });
        sel.addEventListener("change", applyFilters);
        ftd.appendChild(sel);
      } else {
        const inp = document.createElement("input");
        inp.type = "text";
        inp.placeholder = `Filter ${h}â€¦`;
        inp.dataset.col = i;
        inp.addEventListener("input", applyFilters);
        ftd.appendChild(inp);
      }
      filterRow.appendChild(ftd);
    });
  }

  function sortByCol(col, th) {
    if (sortCol === col) sortDir *= -1;
    else { sortCol = col; sortDir = 1; }
    document.querySelectorAll("#header-row th").forEach(t => t.classList.remove("sort-asc", "sort-desc"));
    th.classList.add(sortDir === 1 ? "sort-asc" : "sort-desc");
    applyFilters();
  }

  function applyFilters() {
    const globalSearch = document.getElementById("global-search").value.toLowerCase();
    const colFilters = [...document.querySelectorAll("#filter-row th input, #filter-row th select")]
      .map(el => ({ col: parseInt(el.dataset.col), value: el.value.toLowerCase() }));

    filteredRows = allRows.filter(row => {
      if (globalSearch && !row.some(c => (c || "").toLowerCase().includes(globalSearch))) return false;
      return colFilters.every(f => !f.value || (row[f.col] || "").toLowerCase() === f.value ||
        (document.querySelectorAll("#filter-row th input")[0] &&
        (row[f.col] || "").toLowerCase().includes(f.value)));
    });

    // Fix: dropdowns use exact match, text inputs use includes
    filteredRows = allRows.filter(row => {
      if (globalSearch && !row.some(c => (c || "").toLowerCase().includes(globalSearch))) return false;
      return [...document.querySelectorAll("#filter-row th input, #filter-row th select")].every(el => {
        const val = el.value.toLowerCase();
        const col = parseInt(el.dataset.col);
        if (!val) return true;
        const cellVal = (row[col] || "").toLowerCase();
        return el.tagName === "SELECT" ? cellVal === val : cellVal.includes(val);
      });
    });

    if (sortCol >= 0) {
      filteredRows.sort((a, b) => {
        const av = a[sortCol] || "", bv = b[sortCol] || "";
        const an = parseFloat(av), bn = parseFloat(bv);
        if (!isNaN(an) && !isNaN(bn)) return (an - bn) * sortDir;
        return av.localeCompare(bv) * sortDir;
      });
    }

    renderTable();
  }

  function renderTable() {
    const total = filteredRows.length;
    const tbody = document.getElementById("table-body");
    tbody.innerHTML = "";

    if (filteredRows.length === 0) {
      tbody.innerHTML = `<tr><td colspan="${headers.length}" class="no-data">No matching records found.</td></tr>`;
    } else {
      filteredRows.forEach(row => {
        const tr = document.createElement("tr");
        headers.forEach((h, i) => {
          const td = document.createElement("td");
          const val = row[i] || "";
          td.title = val; // tooltip on hover
          if (i === tmColIndex && val !== "") {
            const a = document.createElement("a");
            a.href = `https://www.trismegistos.org/text/${val}`;
            a.textContent = val;
            a.className = "tm-link";
            a.target = "_blank";
            a.rel = "noopener noreferrer";
            td.appendChild(a);
          } else {
            td.textContent = val;
          }
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
    }

    document.getElementById("row-count").textContent =
      `Showing ${total} of ${allRows.length} row(s)` +
      (total < allRows.length ? ` (filtered)` : "");
  }

  function clearAllFilters() {
    document.getElementById("global-search").value = "";
    document.querySelectorAll("#filter-row th input").forEach(i => i.value = "");
    document.querySelectorAll("#filter-row th select").forEach(s => s.selectedIndex = 0);
    sortCol = -1; sortDir = 1;
    document.querySelectorAll("#header-row th").forEach(t => t.classList.remove("sort-asc", "sort-desc"));
    applyFilters();
  }

  function exportCSV() {
    const csvRows = [headers, ...filteredRows]
      .map(r => r.map(c => `"${(c || "").replace(/"/g, '""')}"`).join(","))
      .join("\n");
    const a = document.createElement("a");
    a.href = "data:text/csv;charset=utf-8," + encodeURIComponent(csvRows);
    a.download = "export.csv";
    a.click();
  }

  loadSheet();
</script>
